include/master-slave.inc
[connection master]
connect  master2,localhost,root,,;
connection master;
CALL mtr.add_suppression("Found 1 prepared XA transactions");
CALL mtr.add_suppression("Found 2 prepared XA transactions");
CALL mtr.add_suppression("Found 3 prepared XA transactions");
CREATE TABLE t ( f INT ) ENGINE=INNODB;
XA START 'xa1';
INSERT INTO t VALUES (20);
XA END 'xa1';
XA PREPARE 'xa1';
connection slave;
include/stop_slave.inc
connection master1;
use test;
xa start 'xa2';
insert into t values (30);
xa end 'xa2';
SET DEBUG_SYNC="simulate_hang_after_binlog_prepare SIGNAL reached WAIT_FOR go";
xa prepare 'xa2';
connection master2;
SELECT * FROM INFORMATION_SCHEMA.PROCESSLIST;
ID	USER	HOST	DB	COMMAND	TIME	STATE	INFO	TIME_MS	STAGE	MAX_STAGE	PROGRESS	MEMORY_USED	MAX_MEMORY_USED	EXAMINED_ROWS	QUERY_ID	INFO_BINARY	TID
11	root	localhost	test	Query	0	Filling schema table	SELECT * FROM INFORMATION_SCHEMA.PROCESSLIST	0.583	0	0	0.000	124544	124544	0	162	SELECT * FROM INFORMATION_SCHEMA.PROCESSLIST	6342
10	root	localhost:35128	test	Query	0	debug sync point: simulate_hang_after_binlog_prepare	xa prepare 'xa2'	0.665	0	0	0.000	81328	81328	0	161	xa prepare 'xa2'	6339
9	root	localhost:35126	test	Sleep	0		NULL	29.028	0	0	0.000	81328	84640	0	155	NULL	6338
8	root	localhost:35124	NULL	Binlog Dump	0	Master has sent all binlog to slave; waiting for binlog to be up	NULL	84.966	0	0	0.000	73328	251416	0	76	NULL	6337
7	root	localhost:35122	test	Sleep	0		NULL	123.112	0	0	0.000	74080	74592	0	46	NULL	6334
6	root	localhost:35120	test	Sleep	0		NULL	40.158	0	0	0.000	74080	74592	0	133	NULL	6333
5	root	localhost	test	Sleep	0		NULL	39.708	0	0	0.000	72776	251160	0	134	NULL	6328
XA START 'xa3';
INSERT INTO t VALUES (40);
XA END 'xa3';
SET GLOBAL DEBUG_DBUG="d,simulate_crash_after_binlog_prepare";
XA PREPARE 'xa3';
ERROR HY000: Lost connection to MySQL server during query
connection master1;
ERROR HY000: Lost connection to MySQL server during query
connection master;
connection default;
connection server_1;
connection master;
connection slave;
include/start_slave.inc
connection master;
SELECT * FROM t;
f
XA RECOVER;
formatID	gtrid_length	bqual_length	data
1	3	0	xa3
1	3	0	xa1
1	3	0	xa2
XA COMMIT 'xa1';
XA COMMIT 'xa2';
XA COMMIT 'xa3';
SELECT * FROM t;
f
20
30
40
connection slave;
SELECT * FROM t;
f
20
30
40
connection master;
DROP TABLE t;
connection slave;
SHOW SLAVE STATUS;
Slave_IO_State	Waiting for master to send event
Master_Host	127.0.0.1
Master_User	root
Master_Port	16000
Connect_Retry	1
Master_Log_File	master-bin.000002
Read_Master_Log_Pos	903
Relay_Log_File	slave-relay-bin.000004
Relay_Log_Pos	1203
Relay_Master_Log_File	master-bin.000002
Slave_IO_Running	Yes
Slave_SQL_Running	Yes
Replicate_Do_DB	
Replicate_Ignore_DB	
Replicate_Do_Table	
Replicate_Ignore_Table	
Replicate_Wild_Do_Table	
Replicate_Wild_Ignore_Table	
Last_Errno	0
Last_Error	
Skip_Counter	0
Exec_Master_Log_Pos	903
Relay_Log_Space	2342
Until_Condition	None
Until_Log_File	
Until_Log_Pos	0
Master_SSL_Allowed	No
Master_SSL_CA_File	
Master_SSL_CA_Path	
Master_SSL_Cert	
Master_SSL_Cipher	
Master_SSL_Key	
Seconds_Behind_Master	0
Master_SSL_Verify_Server_Cert	No
Last_IO_Errno	0
Last_IO_Error	
Last_SQL_Errno	0
Last_SQL_Error	
Replicate_Ignore_Server_Ids	
Master_Server_Id	1
Master_SSL_Crl	
Master_SSL_Crlpath	
Using_Gtid	No
Gtid_IO_Pos	
Replicate_Do_Domain_Ids	
Replicate_Ignore_Domain_Ids	
Parallel_Mode	optimistic
SQL_Delay	0
SQL_Remaining_Delay	NULL
Slave_SQL_Running_State	Slave has read all relay log; waiting for the slave I/O thread to update it
Slave_DDL_Groups	2
Slave_Non_Transactional_Groups	3
Slave_Transactional_Groups	6
include/rpl_end.inc
